name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: Nix Flake Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check flake
        run: nix flake check --all-systems

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check formatting
        run: |
          nix fmt -- --ci .
          echo "✓ All files are properly formatted"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Lint shell scripts
        run: |
          nix build .#checks.x86_64-linux.shellcheck
          echo "✓ Shell scripts pass shellcheck"

      - name: Lint GitHub Actions
        run: |
          nix develop .#default --command actionlint
          echo "✓ GitHub Actions are valid"

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          nix build .#checks.x86_64-linux.unit-tests --print-build-logs
          echo "✓ Unit tests pass"

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          nix build .#checks.x86_64-linux.integration --print-build-logs
          echo "✓ Integration tests pass"

      - name: Run all checks
        run: |
          nix build .#checks.x86_64-linux.all-tests
          nix build .#checks.x86_64-linux.eval
          echo "✓ All tests pass"

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            system: x86_64-linux
          - os: macos-latest
            system: aarch64-darwin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build documentation
        run: nix build .#docs

      - name: Evaluate models
        run: |
          nix eval .#modelDefs --json | jq .
          echo "✓ Model definitions evaluate successfully"

      - name: Run tests
        run: |
          nix build .#checks.${{ matrix.system }}.unit-tests
          nix build .#checks.${{ matrix.system }}.integration
          echo "✓ Tests pass on ${{ matrix.system }}"

  # Build test models (optional, can be slow)
  build-models:
    name: Build Test Models
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'test-models')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build test models
        run: |
          # Build mock/test models only (no network required)
          nix build .#models.x86_64-linux.test.empty --print-build-logs
          nix build .#models.x86_64-linux.test.minimal --print-build-logs
          echo "✓ Test models build successfully"
