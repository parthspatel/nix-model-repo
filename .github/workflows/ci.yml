name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: Nix Flake Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check flake
        run: nix flake check --all-systems

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check formatting
        run: |
          nix fmt -- --check .
          echo "✓ All files are properly formatted"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Lint shell scripts
        run: |
          nix develop .#ci --command shellcheck fetchers/*.sh
          echo "✓ Shell scripts pass shellcheck"

      - name: Lint GitHub Actions
        run: |
          nix develop .#default --command actionlint
          echo "✓ GitHub Actions are valid"

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build documentation
        run: nix build .#docs

      - name: Evaluate models
        run: |
          nix eval .#modelDefs --json | jq .
          echo "✓ Model definitions evaluate successfully"

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Run checks
        run: |
          nix build .#checks.x86_64-linux.types
          nix build .#checks.x86_64-linux.shellcheck
          nix build .#checks.x86_64-linux.eval
          echo "✓ All checks pass"

  # Build test models (optional, can be slow)
  build-models:
    name: Build Test Models
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'test-models')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build test models
        run: |
          # Build mock/test models only (no network required)
          nix build .#models.x86_64-linux.test.empty --print-build-logs
          nix build .#models.x86_64-linux.test.minimal --print-build-logs
          echo "✓ Test models build successfully"
